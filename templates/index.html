{% extends "base.html" %}

{% block title %}Dashboard - PlanCheck{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="bi bi-speedometer2"></i> Dashboard</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Equipamentos</h6>
                        <h2 class="mb-0">{{ total_equipamentos }}</h2>
                    </div>
                    <i class="bi bi-gear-fill" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Planos</h6>
                        <h2 class="mb-0">{{ total_planos }}</h2>
                    </div>
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total de Ordens</h6>
                        <h2 class="mb-0">{{ total_ordens }}</h2>
                    </div>
                    <i class="bi bi-list-check" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Ordens Pendentes</h6>
                        <h2 class="mb-0">{{ ordens_pendentes }}</h2>
                    </div>
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Cumprimento de Planos por Equipamento</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="equipamentosTable">
                        <thead>
                            <tr>
                                <th>Equipamento</th>
                                <th>Código</th>
                                <th class="text-center">Programadas</th>
                                <th class="text-center">Realizadas</th>
                                <th class="text-center">% Cumprimento</th>
                            </tr>
                        </thead>
                        <tbody id="equipamentosTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Status das Ordens</h5>
            </div>
            <div class="card-body">
                <canvas id="ordensChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Cumprimento Mensal de Ordens</h5>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="mensalChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-task"></i> Lista de Ordens</h5>
                <div class="d-flex gap-2">
                    <input type="date" id="dataInicio" class="form-control form-control-sm" style="width: 150px;">
                    <input type="date" id="dataFim" class="form-control form-control-sm" style="width: 150px;">
                    <button class="btn btn-primary btn-sm" onclick="filtrarOrdens()">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="limparFiltros()">
                        <i class="bi bi-x-circle"></i> Limpar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Status</th>
                                <th>Plano</th>
                                <th>Equipamento</th>
                                <th>Executante</th>
                                <th class="text-center">Data Programada</th>
                                <th class="text-center">Data Realizada</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="ordensTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Carregando ordens...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function getStatusIcon(status_visual) {
    const icons = {
        'pendente': '<i class="bi bi-clock-fill text-warning" title="Pendente"></i>',
        'no_prazo': '<i class="bi bi-check-circle-fill text-success" title="No Prazo"></i>',
        'concluido': '<i class="bi bi-check-circle-fill text-success" title="Concluído"></i>',
        'atrasado': '<i class="bi bi-exclamation-triangle-fill text-danger" title="Atrasado"></i>',
        'em_andamento': '<i class="bi bi-arrow-clockwise text-primary" title="Em Andamento"></i>'
    };
    return icons[status_visual] || '';
}

function carregarOrdens(dataInicio = '', dataFim = '') {
    let url = '/api/dashboard/ordens';
    const params = new URLSearchParams();
    
    if (dataInicio) params.append('data_inicio', dataInicio);
    if (dataFim) params.append('data_fim', dataFim);
    
    if (params.toString()) url += '?' + params.toString();
    
    fetch(url)
        .then(response => response.json())
        .then(ordens => {
            const tbody = document.getElementById('ordensTableBody');
            
            if (ordens && ordens.length > 0) {
                tbody.innerHTML = '';
                ordens.forEach(ordem => {
                    const row = `
                        <tr>
                            <td class="text-center">${getStatusIcon(ordem.status_visual)}</td>
                            <td>${ordem.plano}</td>
                            <td>${ordem.equipamento}</td>
                            <td>${ordem.executante}</td>
                            <td class="text-center">${ordem.data_programada}</td>
                            <td class="text-center">${ordem.data_realizada}</td>
                            <td class="text-center">
                                <a href="/ordens/${ordem.id}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhuma ordem encontrada</td></tr>';
            }
        });
}

function filtrarOrdens() {
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    carregarOrdens(dataInicio, dataFim);
}

function limparFiltros() {
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    carregarOrdens();
}

document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/dashboard/stats')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('equipamentosTableBody');
            
            if (data.equipamentos && data.equipamentos.length > 0) {
                tbody.innerHTML = '';
                data.equipamentos.forEach(eq => {
                    const percentualClass = eq.percentual >= 80 ? 'text-success' : eq.percentual >= 50 ? 'text-warning' : 'text-danger';
                    const row = `
                        <tr>
                            <td>${eq.equipamento}</td>
                            <td>${eq.codigo}</td>
                            <td class="text-center">${eq.programadas}</td>
                            <td class="text-center">${eq.realizadas}</td>
                            <td class="text-center">
                                <strong class="${percentualClass}">${eq.percentual}%</strong>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum equipamento cadastrado</td></tr>';
            }

            const ordensCtx = document.getElementById('ordensChart').getContext('2d');
            new Chart(ordensCtx, {
                type: 'bar',
                data: {
                    labels: ['Pendentes', 'Em Andamento', 'Concluídas'],
                    datasets: [{
                        label: 'Ordens',
                        data: [data.ordens.pendentes, data.ordens.em_andamento, data.ordens.concluidas],
                        backgroundColor: ['#ffc107', '#295673', '#7AAD6B']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            const mensalCtx = document.getElementById('mensalChart').getContext('2d');
            new Chart(mensalCtx, {
                type: 'bar',
                data: {
                    labels: data.mensal.meses,
                    datasets: [{
                        label: 'Programadas',
                        data: data.mensal.programadas,
                        backgroundColor: '#295673'
                    }, {
                        label: 'Realizadas',
                        data: data.mensal.realizadas,
                        backgroundColor: '#7AAD6B'
                    }, {
                        label: '% Cumprimento',
                        data: data.mensal.percentual,
                        backgroundColor: '#C7D7E4',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Quantidade de Ordens'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: '% Cumprimento'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        });
    
    carregarOrdens();
});
</script>
{% endblock %}
