{% extends "base.html" %}

{% block title %}Mapa Anual de Planos - PlanCheck{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-3"><i class="bi bi-calendar3"></i> Mapa Anual de Planos {{ ano_atual }}</h1>
        <p class="text-muted">Visualização de todos os planos de inspeção ao longo das 52 semanas do ano. Semana atual: <strong>{{ semana_atual }}</strong></p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Cronograma Anual</h5>
                    <small class="text-muted">{{ mapa_planos|length }} planos ativos</small>
                </div>
                <div>
                    <span class="badge bg-success me-2">✓ Previsto</span>
                    <span class="badge" style="background-color: #295673;">◉ Semana Atual</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 800px; overflow-x: auto; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0" style="font-size: 0.85rem;">
                        <thead style="position: sticky; top: 0; z-index: 10; background-color: white;">
                            <tr class="bg-light">
                                <th style="position: sticky; left: 0; z-index: 11; background-color: #f8f9fa; min-width: 280px;" class="border-end">
                                    Equipamento / Plano
                                </th>
                                {% for semana in semanas %}
                                <th class="text-center border-start" style="min-width: 30px; {% if semana.numero == semana_atual %}background-color: #295673; color: white;{% endif %}">
                                    <div style="writing-mode: vertical-rl; text-orientation: mixed; height: 60px; display: flex; align-items: center; justify-content: center;">
                                        S{{ semana.numero }}
                                    </div>
                                </th>
                                {% endfor %}
                            </tr>
                            <tr class="bg-secondary text-white" style="font-size: 0.75rem;">
                                <th style="position: sticky; left: 0; z-index: 11; background-color: #6c757d;" class="border-end">
                                    Localização
                                </th>
                                {% set mes_anterior = '' %}
                                {% for semana in semanas %}
                                <th class="text-center {% if semana.mes != mes_anterior %}border-start border-dark{% endif %}" style="{% if semana.numero == semana_atual %}background-color: #1d4052;{% endif %}">
                                    {% if semana.mes != mes_anterior %}
                                        {{ semana.mes }}
                                        {% set mes_anterior = semana.mes %}
                                    {% endif %}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% if mapa_planos %}
                                {% for item in mapa_planos %}
                                <tr>
                                    <td style="position: sticky; left: 0; z-index: 5; background-color: white;" class="border-end">
                                        <div>
                                            <strong class="text-primary">{{ item.equipamento_nome }}</strong>
                                            <span class="badge bg-secondary ms-1">{{ item.equipamento_codigo }}</span>
                                        </div>
                                        <div style="font-size: 0.8rem;">
                                            <i class="bi bi-file-earmark-text"></i> {{ item.plano.titulo }}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #666;">
                                            <i class="bi bi-geo-alt"></i> {{ item.localizacao }}
                                        </div>
                                        <div style="font-size: 0.75rem;" class="mt-1">
                                            <span class="badge bg-info">{{ item.total_execucoes }} execuções/ano</span>
                                            {% if item.plano.tipo_geracao == 'diario' %}
                                                <span class="badge bg-secondary">Diário: {{ item.plano.frequencia|int }} dias</span>
                                            {% elif item.plano.tipo_geracao == 'por_hora' %}
                                                <span class="badge bg-secondary">Por hora: {{ item.plano.frequencia|int }}h</span>
                                            {% elif item.plano.tipo_geracao == 'data_abertura' %}
                                                <span class="badge bg-secondary">Data específica</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    {% for semana in semanas %}
                                    <td class="text-center align-middle border-start" 
                                        style="padding: 4px; {% if semana.numero == semana_atual %}background-color: #e8f4f8;{% endif %}">
                                        {% if semana.numero in item.semanas_execucao %}
                                            <span class="badge bg-success" style="font-size: 1rem;" title="Previsto: Semana {{ semana.numero }}">✓</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="{{ semanas|length + 1 }}" class="text-center text-muted py-5">
                                        <i class="bi bi-calendar-x" style="font-size: 3rem;"></i>
                                        <p class="mt-3">Nenhum plano com data de início configurada.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Legenda</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Tipos de Geração:</h6>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-secondary">Diário</span> - Execução a cada X dias</li>
                            <li><span class="badge bg-secondary">Por hora</span> - Execução a cada X horas (convertido para dias)</li>
                            <li><span class="badge bg-secondary">Data específica</span> - Execução única na data programada</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Indicadores:</h6>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-success">✓</span> - Execução prevista nesta semana</li>
                            <li><span class="badge" style="background-color: #295673;">◉</span> - Semana atual ({{ semana_atual }})</li>
                            <li><span class="badge bg-info">N execuções/ano</span> - Total de execuções previstas no ano</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Mapa Anual de Planos carregado!');
</script>
{% endblock %}
